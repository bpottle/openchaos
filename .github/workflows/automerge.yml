name: Merge top-voted PR daily

on:
  schedule:
    - cron: "0 19 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  merge-top-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get top PR and merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log('Starting automerge process...');
            console.log(`Repository: ${owner}/${repo}`);
            
            // Run the get-top-pr script that uses the same logic as the website
            console.log('Fetching PRs using centralized script...');
            let prs;
            try {
              const output = execSync('node scripts/get-top-pr.mjs', {
                encoding: 'utf-8',
                env: { ...process.env, GITHUB_TOKEN: process.env.GITHUB_TOKEN }
              });
              prs = JSON.parse(output);
            } catch (error) {
              console.error('Error fetching PRs:', error.message);
              console.log('The script ensures pagination, mergeability checks, and rhyming word validation.');
              return;
            }
            
            console.log(`Found ${prs.length} open PRs`);
            
            if (prs.length === 0) {
              console.log('No open PRs found.');
              return;
            }
            
            // Filter to mergeable PRs with passing checks (already sorted correctly by script)
            const mergeablePRs = prs.filter(pr => pr.isMergeable && pr.checksPassed);
            
            console.log('\n=== PR Status Summary ===');
            prs.slice(0, 10).forEach(pr => {
              console.log(
                `PR #${pr.number} (Rank ${pr.rank}): ${pr.votes} votes ` +
                `(${pr.upvotes} up, ${pr.downvotes} down) | ` +
                `Mergeable: ${pr.isMergeable} | CI: ${pr.checksPassed}`
              );
            });
            
            console.log(`\n${mergeablePRs.length} PRs are eligible for merge`);
            
            if (mergeablePRs.length === 0) {
              console.log('No mergeable PRs found. All PRs either:');
              console.log('  - Have merge conflicts');
              console.log('  - Have failing CI checks');
              console.log('  - Missing rhyming words in title');
              return;
            }
            
            const topPR = mergeablePRs[0];
            
            console.log('\n=== Merge Decision ===');
            console.log(`Top mergeable PR: #${topPR.number} by @${topPR.author}`);
            console.log(`Title: ${topPR.title}`);
            console.log(`Net votes: ${topPR.votes} (${topPR.upvotes} up, ${topPR.downvotes} down)`);
            console.log(`URL: ${topPR.url}`);
            
            if (topPR.votes <= 0) {
              console.log('\nTop PR has 0 or negative votes â€” skipping merge.');
              return;
            }
            
            console.log(`\nAttempting to merge PR #${topPR.number}...`);
            
            try {
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: topPR.number,
                merge_method: 'squash',
                commit_title: `Merge PR #${topPR.number}: ${topPR.title}`,
                commit_message: `Automatically merged PR with ${topPR.votes} net votes (${topPR.upvotes} upvotes, ${topPR.downvotes} downvotes)\nAuthor: @${topPR.author}`
              });
              
              console.log(`Successfully merged PR #${topPR.number}`);
              
              // Add a comment to the PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: topPR.number,
                body: `This PR won the daily vote with **${topPR.votes} net votes** (${topPR.upvotes} upvotes, ${topPR.downvotes} downvotes) and has been automatically merged!\n\nThanks @${topPR.author} for contributing to the chaos!`
              });
              
            } catch (error) {
              console.error(`Failed to merge PR #${topPR.number}: ${error.message}`);
              
              // Try to merge the next eligible PR
              if (mergeablePRs.length > 1) {
                console.log('\nAttempting to merge the next eligible PR...');
                const nextPR = mergeablePRs[1];
                
                console.log(`Next in line: PR #${nextPR.number} by @${nextPR.author}`);
                console.log(`Title: ${nextPR.title}`);
                console.log(`Net votes: ${nextPR.votes}`);
                
                try {
                  await github.rest.pulls.merge({
                    owner,
                    repo,
                    pull_number: nextPR.number,
                    merge_method: 'squash',
                    commit_title: `Merge PR #${nextPR.number}: ${nextPR.title}`,
                    commit_message: `Automatically merged PR with ${nextPR.votes} net votes (${nextPR.upvotes} upvotes, ${nextPR.downvotes} downvotes)\nAuthor: @${nextPR.author}\n\n(Top PR #${topPR.number} could not be merged)`
                  });
                  
                  console.log(`Successfully merged fallback PR #${nextPR.number}`);
                  
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: nextPR.number,
                    body: `This PR was automatically merged as the runner-up with **${nextPR.votes} net votes** (${nextPR.upvotes} upvotes, ${nextPR.downvotes} downvotes).\n\n(The top PR #${topPR.number} could not be merged)\n\nThanks @${nextPR.author} for contributing to the chaos!`
                  });
                  
                } catch (fallbackError) {
                  console.error(`Failed to merge fallback PR #${nextPR.number}: ${fallbackError.message}`);
                }
              } else {
                console.log('No other eligible PRs to try.');
              }
            }

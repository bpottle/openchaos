<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenChaos - GitHub PR Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>OpenChaos</h1>
        <p class="subtitle">Vote for the next community PR!</p>
        
        <div class="countdown-section">
            <div class="countdown-timer" id="countdown">--d --h --m --s</div>
            <div class="countdown-label">until next merge</div>
        </div>

        <div class="performance-banner">
            <h3>Built with Rust</h3>
            <div class="performance-stats">
                <div class="stat-item">
                    <div class="stat-value" id="stat-binary-size">~5MB</div>
                    <div class="stat-label">Binary Size</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-response-time">&lt;10ms</div>
                    <div class="stat-label">Avg Response</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-errors">0</div>
                    <div class="stat-label">Runtime Errors</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-uptime">0s</div>
                    <div class="stat-label">Uptime</div>
                </div>
            </div>
        </div>
        
        <div class="input-group">
            <input type="text" id="owner" placeholder="Repository Owner" value="skridlevsky">
            <input type="text" id="repo" placeholder="Repository Name" value="openchaos">
            <button onclick="loadPRs()">Load Pull Requests</button>
        </div>
        
        <div id="prList"></div>
    </div>

    <script>
        async function loadPRs() {
            const owner = document.getElementById('owner').value;
            const repo = document.getElementById('repo').value;
            const prList = document.getElementById('prList');
            
            if (!owner || !repo) {
                prList.innerHTML = '<div class="pr-card error">Please enter both owner and repository name</div>';
                return;
            }
            
            prList.innerHTML = '<div class="loading">Loading pull requests...</div>';
            
            try {
                const response = await fetch(`/api/pulls?owner=${owner}&repo=${repo}`);
                const data = await response.json();
                
                if (data.pulls.length === 0) {
                    prList.innerHTML = `
                        <div class="loading">
                            <h2>Failed to fetch OpenChaos.dev PRs</h2>
                        </div>
                    `;
                    return;
                }
                
                prList.innerHTML = data.pulls.map((pr, index) => {
                    const netVotes = (pr.reactions['+1'] || 0) - (pr.reactions['-1'] || 0);
                    return `
                    <div class="pr-card">
                        <div class="pr-header">
                            <div style="display: flex; align-items: center; gap: 15px; flex: 1; min-width: 0;">
                                <img src="${pr.user.avatar_url}" alt="${pr.user.login}" class="pr-avatar">
                                <div class="pr-info" style="flex: 1; min-width: 0;">
                                    <div class="pr-title">${escapeHtml(pr.title)}</div>
                                    <div class="pr-meta">
                                        <span class="pr-number">#${pr.number}</span>
                                        ${index === 0 ? '<span class="leading-badge">Leading</span>' : ''}
                                        by ${escapeHtml(pr.user.login)}
                                    </div>
                                </div>
                            </div>
                            <div class="vote-count">
                                <span>üëç</span>
                                <span>${netVotes}</span>
                            </div>
                        </div>
                        <div class="pr-meta">
                            Created: ${new Date(pr.created_at).toLocaleDateString()} | 
                            Updated: ${new Date(pr.updated_at).toLocaleDateString()}
                        </div>
                        <a href="${pr.html_url}" target="_blank" class="pr-link">View & Vote on GitHub ‚Üí</a>
                    </div>
                `;
                }).join('');
                
            } catch (error) {
                prList.innerHTML = '<div class="pr-card error">Error loading pull requests. Please try again.</div>';
                console.error('Error:', error);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Countdown timer functions
        function getNextSunday9UTC() {
            const now = new Date();
            const target = new Date(now);

            // Set to next Sunday
            const daysUntilSunday = (7 - now.getUTCDay()) % 7;
            target.setUTCDate(now.getUTCDate() + (daysUntilSunday === 0 ? 7 : daysUntilSunday));

            // Set to 09:00 UTC
            target.setUTCHours(9, 0, 0, 0);

            // If it's Sunday but before 09:00 UTC, use today
            if (now.getUTCDay() === 0 && now.getUTCHours() < 9) {
                target.setUTCDate(now.getUTCDate());
            }

            return target;
        }

        function getTimeRemaining(target) {
            const now = new Date();
            const diff = Math.max(0, target.getTime() - now.getTime());

            const seconds = Math.floor((diff / 1000) % 60);
            const minutes = Math.floor((diff / 1000 / 60) % 60);
            const hours = Math.floor((diff / 1000 / 60 / 60) % 24);
            const days = Math.floor(diff / 1000 / 60 / 60 / 24);

            return { days, hours, minutes, seconds };
        }

        function pad(n) {
            return n.toString().padStart(2, '0');
        }

        function updateCountdown() {
            const target = getNextSunday9UTC();
            const time = getTimeRemaining(target);
            const countdownEl = document.getElementById('countdown');
            
            if (countdownEl) {
                countdownEl.textContent = `${time.days}d ${pad(time.hours)}h ${pad(time.minutes)}m ${pad(time.seconds)}s`;
            }
        }

        // Initialize countdown
        updateCountdown();
        setInterval(updateCountdown, 1000);
        
        // Load metrics
        async function loadMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();
                
                // Update binary size
                document.getElementById('stat-binary-size').textContent = data.binary_size_formatted;
                
                // Update average response time
                const responseTime = data.avg_response_time_ms;
                document.getElementById('stat-response-time').textContent = 
                    responseTime === 0 ? '<1ms' : `${responseTime}ms`;
                
                // Update runtime errors
                document.getElementById('stat-errors').textContent = data.total_errors;
                
                // Update uptime
                const uptimeSeconds = data.uptime_seconds;
                let uptimeText;
                if (uptimeSeconds < 60) {
                    uptimeText = `${uptimeSeconds}s`;
                } else if (uptimeSeconds < 3600) {
                    const minutes = Math.floor(uptimeSeconds / 60);
                    uptimeText = `${minutes}m`;
                } else if (uptimeSeconds < 86400) {
                    const hours = Math.floor(uptimeSeconds / 3600);
                    uptimeText = `${hours}h`;
                } else {
                    const days = Math.floor(uptimeSeconds / 86400);
                    uptimeText = `${days}d`;
                }
                document.getElementById('stat-uptime').textContent = uptimeText;
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }
        
        // Load openchaos repo and metrics on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadPRs();
            loadMetrics();
            // Refresh metrics every 5 seconds
            setInterval(loadMetrics, 5000);
        });
    </script>
</body>
</html>
